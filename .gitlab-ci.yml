stages:
  - build
  - deploy
  - site

variables:
  build_img: alpine:3.15.4
  curl_img: curlimages/curl:7.83.0
  pkg_name: "${CI_PROJECT_NAME}.zip"
  pkg_url:
    "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${CI_PROJECT_NAME}/${CI_COMMIT_TAG}"

make:
  image: ${build_img}
  stage: build
  script:
  - apk add git zip
  - ./pkg.sh
  artifacts:
    paths:
      - "*.zip"
      - "*sha*.txt"
      - "${pkg_name}*"
    expire_in: 10 minutes
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_TAG

pages:
  stage: site
  artifacts:
    paths:
      - public
    expire_in: 10 minutes
  image: ${build_img}
  script:
    - apk add bash cmark git highlight
    - git fetch --all
    - git submodule init
    - git submodule update
    - ./web/build.sh --profile prod --debug
    - mv web/build public
  rules:
    - if: $CI_COMMIT_BRANCH == "master"

upload:
  stage: deploy
  image: ${curl_img}
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - 'curl -s --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file $(echo  $CI_COMMIT_TAG | cut -f 1 -d -).zip "${pkg_url}/$(echo  $CI_COMMIT_TAG | cut -f 1 -d -).zip"'
    - 'curl -s --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file $(echo  $CI_COMMIT_TAG | cut -f 1 -d -).sha256sum.txt "${pkg_url}/$(echo  $CI_COMMIT_TAG | cut -f 1 -d -).sha256sum.txt"'
    - 'curl -s --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file $(echo  $CI_COMMIT_TAG | cut -f 1 -d -).sha512sum.txt "${pkg_url}/$(echo  $CI_COMMIT_TAG | cut -f 1 -d -).sha512sum.txt"'
