[settings]
  soupault_version = "4.3.1"
  strict = true
  # verbose = true
  # debug = true
  site_dir = "site"
  build_dir = "build"
  page_file_extensions = ["htm", "html", "md", "rst", "adoc"]
  ignore_extensions = ["draft"]
  generator_mode = true
  complete_page_selector = "html"
  default_template_file = "templates/main.html"
  default_content_selector = "div#content"
  default_content_action = "append_child"
  keep_doctype = true
  doctype = "<!DOCTYPE html>"
  pretty_print_html = true
  clean_urls = true
  plugin_discovery = true
  plugin_dirs = ["plugins"]
  ignore_directories = [
    "packages",
    "plugins",
    "templates",
    "web",
    ".git",
    ".vscode",
  ]

[preprocessors]
  md = "cmark --unsafe --smart"

# [BUILDER]
# 1. Clear out any old files
# 2. Copy relevant files into the site directory
# 3. Generate fake changelogs where necessary
# 4. Store used mod directories in global_data
# As a startup hook, this stage occurs before anything else
[hooks.startup]
  file = 'plugins/mod-info.lua'
  # This should be the GitLab account to which your site will be deployed
  org = "modding-openmw"
  # This is the name of your repository
  project = "s3ctors-s3cret-st4sh"
  # Disable this if you wish to only host one mod on your site.
  multi_mod = true

  # Include links to download file digests
  # for verification purposes
  use_digests = true

  # MANDATORY: Omits certain directories during the build process
  # Do not remove any of these, or you will start a big fire
  # But feel free to add new ones!
  global_exclude_paths = "js|.git|web|img|css|.vscode|packages|Survival|Empowered Races"

# During preprocessing, creates a file to signal prod mode to downstream plugins which can run in non-prod mode,
# But whose behavior may change in prod mode.
[hooks.pre-process]
  profile = 'prod'
  lua_source = """
  if not Sys.is_file('.prod') then
     Sys.write_file('.prod', '')
  end
  """

[widgets.package]
  profile = 'pkg'
  widget = 'package'

[plugins.input-credits]
lua_source = """
if Regex.match(target_file, soupault_config.hooks.startup.global_exclude_paths) or Regex.match(page_url, "changelog") then return end

content = HTML.select_one(page, "div#content")
if not content then
    return Plugin.fail("[CREDITS]: Content div not found!")
end

contentElements = HTML.children(content)
existingCredits = nil
creditsContainer = nil
foundCredits = nil

function ProcessContentElement(element)
    if not foundCredits and HTML.is_element(element) then
        -- Check if it's a h2 with "Credits" text
        if HTML.get_tag_name(element) == "h2" and HTML.inner_text(element) == "Credits" then
            existingCredits = element
            creditsContainer = HTML.create_element("div")
            HTML.set_attribute(creditsContainer, "id", "credits-container")
            HTML.wrap(existingCredits, creditsContainer)
            foundCredits = 1
            return
        end
    end
    
    if foundCredits ~= nil then
        -- Check if we've hit another heading using regex
        if HTML.is_element(element) and Regex.match(HTML.get_tag_name(element), "^h[1-6]$") then
            foundCredits = nil
            return
        end
        
        if HTML.is_element(element) then
            Log.warning("[CREDITS]: Adding element to credits container: " .. HTML.pretty_print(element))
            HTML.append_child(creditsContainer, element)
        end
    end
end

Table.iter_values_ordered(ProcessContentElement, contentElements)

if existingCredits == nil then
    template = Sys.read_file("templates" .. ( Sys.is_windows() and '\\\\' or '/' ) .. "credits.html")
    if not template then
        return Plugin.fail("[CREDITS]: Credits template not found!")
    end

    template = Regex.replace(template, "REPLACE_CREDITS", config[ 'credit_str' ])
    credits = HTML.parse(template)
    HTML.append_child(content, credits)
end
"""

[widgets.credits]
widget = 'input-credits'
credit_str = """
Author: S3ctor

All assets made by Dave Corley under the GPL3 license. 

Please enjoy my mod, hack away as you please, and respect the freedoms of your fellow modders and players in the meantime.
"""

# Creates the modData tag
# Which includes the mod's directory, the project, and the org name
[widgets.mod-paths]
  after = 'credits'
  widget = "insert-data"
  check-selector = "head"
  selector = "modData"

# [TITLE FIXER]
# Writes the name of the document's first header
# To the top of the page and assigns the special
# modHeader class for styling
[widgets.title-fixer]
  after = 'mod-paths'
  widget = "title-fixer"
  # If 'true', puts a notice on release pages
  # Indicating you can get the mod from the dev link
  # dev_warning = 'true'
  dev_message = """
  Releases without a download link can be downloaded as a dev build link above.
  """

# Insert the following element anywhere
# in your root README.md to have a
# list of all available mods inserted there:
# <div id="modMarker"></div>
# This widget will not do anything
# if `multi_mod` is not set to `true`
# This only runs on /index.html and /blog/index.html
[hooks.post-build]
  file = 'plugins/mod-list.lua'

[widgets.fonts]
  after = 'title-fixer'
  widget = "include"
  file = "templates/font.html"
  selector = "#fonts"

# [HEADER FIXER]
[widgets.header]
  after = ["title-fixer"]
  widget = "header-insert"

# Insert the contact form on all pages except the changelogs
# NOTE: Not a builtin plugin, uses plugins/footer-insert.lua from MOMW's ModWeb-Lua
[widgets.footer]
  after = 'header'
  widget = 'footer-insert'
  extra_exclude_dirs = "changelog"
  # The next four fields are for the `Report a Problem` section of the Template.
  # Optionally insert your contact info for each platform.
  # For gitlab issues, just set to `true` to have a link to the issues page,
  # or omit it completely to skip it.
  # Add author tag, support link, and credits text
  irc = "s3kshun8"
  discord = "s3kshun.8"
  email = "corleycomputerrepair@protonmail.ch"
  issues_page = true

[widgets.page-title]
  widget = "title"
  selector = "h2"
  default = "s3ctors-s3cret-st4sh &mdash; Collection of all mods OpenMW Mods developed by S3ctor, Lua and otherwise."
  append = " | s3ctors-s3cret-st4sh &mdash; Collection of all mods OpenMW Mods developed by S3ctor, Lua and otherwise."
  force = false

[widgets.generator-meta]
  widget = "insert_html"
  html = '<meta name="generator" content="soupault">'
  selector = "head"

[widgets.changelog-toc-html]
  widget = "insert_html"
  html = """
  <h2 class="notoc"
      style="text-align: center;"
      id="contents">Contents</h2>
  <div
    style="text-align: center;"
    id="toc">
  </div>
  """
  selector = ["div#content > h2"]
  action = "insert_before"
  exclude_path_regex = '^site/index\.md$|^(.*)changelog(.*)$'

[widgets.table-of-contents]
  after = ["changelog-toc-html"]
  widget = "toc"
  selector = "div#toc"
  min_level = 2
  max_level = 5
  numbered_list = false
  toc_list_class = "toc"
  toc_class_levels = false
  # SUPER Important! This is why the headings are given ids which match their text. It's thus way easier to match them in selectors later on.
  use_heading_slug = true
  valid_html = true
  ignore_heading_selectors = ['.notoc']
  exclude_path_regex = '^site/index\.md$|^(.*)changelog(.*)$'

[widgets.installation]
after = "table-of-contents"
widget = "installInstructions"

# Wrap headings in a link back to the TOC
[widgets.wrap-toc]
  after = ["installation"]
  widget = "wrap"
  wrapper = """
  <a class="backToToc" href="#contents"></a>
  """
  selector = ["#credits-container > #credits", "div#content > h2", "div#content > h3", "div#content > h4", "div#content > h5", "div#content > h6"]
  wrap_all = true
  exclude_path_regex = '^site/index\.md$|^(.*)changelog(.*)$'

[plugins.contents-link]
lua_source = """
if Regex.match(target_file, soupault_config.hooks.startup.global_exclude_paths) or Regex.match(page_url, "changelog") then return end

content = HTML.select_one(page, "div#content")
if content == nil then
    return Plugin.fail("[CONTENTS LINK]: Content div not found: " .. page_url)
end

contentsHeader = HTML.select_one(content, "h2#contents")
if contentsHeader == nil then
    return Log.warning("[CONTENTS LINK]: Contents header not found: " .. page_url)
end

parentLink = HTML.parent(contentsHeader)
if parentLink == nil then
    return Plugin.fail("[CONTENTS LINK]: No parent element found!")
end

Log.debug("[CONTENTS LINK] Debug dump of parent element: " .. HTML.to_string(parentLink))

modHeader = HTML.select_one(page, "a.modHeader")
if modHeader == nil then
    return Log.warning("[CONTENTS LINK]: No modHeader found on " .. page_url)
end

modId = HTML.get_attribute(modHeader, "id")
if modId == nil then
    return Log.warning("[CONTENTS LINK]: modHeader has no ID on " .. page_url)
end

Log.debug("[CONTENTS LINK]: Found modHeader with id: " .. modId)
HTML.set_attribute(parentLink, "href", "#" .. modId)
"""

[widgets.contents-link]
after = ["wrap-toc"]
widget = "contents-link"

[widgets.prod-mode]
  after = [
    "header",
    "highlight-active-link",
    "highlight-code-css",
    "highlight-code-darkmode-css"
  ]
  widget = "prod-mode"
  profile = "prod"
  project = "s3ctors-s3cret-st4sh"

[widgets.highlight-active-link]
  widget = "section-link-highlight"
  selector = "nav#nav"
  active_link_class = "bold"

[widgets.highlight-code]
  widget = "preprocess_element"
  selector = '*[class^="language-"]'
  command = 'highlight -O html -f --syntax=$(echo $ATTR_CLASS | sed -e "s/language-//")'

[widgets.highlight-code-css]
  widget = "insert-if"
  html = "<link rel='stylesheet' type='text/css' href='/css/highlight.css' />"
  selector = "head"
  check_selector = "code"

[widgets.highlight-code-darkmode-css]
  widget = "insert-if"
  html = "<link rel='stylesheet' type='text/css' media='(prefers-color-scheme: dark)' href='/css/highlight-dark.css'/>"
  selector = "head"
  check_selector = "code"

[widgets.tracking-js]
  profile = "prod"
  widget = "insert_html"
  html = '<script data-goatcounter="https://stats.gitlab.modding-openmw.com/count" async src="https://stats.gitlab.modding-openmw.com/count.js"></script>'
  selector = "body"
  parse = true
